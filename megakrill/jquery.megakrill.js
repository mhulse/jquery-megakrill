/*!
 * jQuery MegaKrill
 * Compact navigation for mobile devices and responsive layouts!
 *
 * @author Micky Hulse
 * @link http://hulse.me
 * @docs https://github.com/registerguard/jquery-megakrill
 * @copyright Copyright (c) 2013 Micky Hulse.
 * @license Released under the Apache License, Version 2.0.
 * @version 1.0.0
 * @date 2013/02/11
 *///----------------------------------

// Notes to self:
//console.profile('profile foo');
// ... code here ...
//console.profileEnd('profile foo');
// ... or:
// console.time('timing foo');
// ... code here ...
// console.timeEnd('timing foo');

//----------------------------------

// @TODO:
// Focus to open?
// Improve "doc" comments.
// Add option to use existing "toggle" button in HTML (i.e. not generated by this script).

//----------------------------------

;(function($, window, document, undefined) {
	
	'use strict';
	
	//--------------------------------------------------------------------------
	//
	// Globals:
	//
	//--------------------------------------------------------------------------
	
	var console = window.console || { log : function() {}, warn : function() {} }, // Javascript `console`.
	
	//--------------------------------------------------------------------------
	//
	// Constants:
	//
	//--------------------------------------------------------------------------
	
	/**
	 * Commonly used variables.
	 *
	 * @type { object }
	 *
	 * @const
	 */
	
	constants = {
		
		NS     : 'megakrill', // Namespace identifier.
		PREFIX : 'mk'         // Class prefix.
		
	}, // constants
	
	//--------------------------------------------------------------------------
	//
	// Public methods:
	//
	//--------------------------------------------------------------------------
	
	/**
	 * Methods object.
	 *
	 * @type { object }
	 */
	
	methods = {
		
		/**
		 * Init constructor.
		 *
		 * @type   { function }
		 * @param  { object } opts Options object literal.
		 * @this   { object.jquery }
		 * @return { object.jquery } Returns target object(s) for chaining purposes.
		 */
		
		init : function(opts) {
			
			//----------------------------------
			// Loop & return each `this`:
			//----------------------------------
			
			return this.each(function() {
				
				//----------------------------------
				// Local variable(s):
				//----------------------------------
				
				var $this   = $(this),                                                            // Target object.
				    data    = $this.data(constants.NS),                                           // Namespace instance `data`.
				    options = $.extend({}, settings.external, $.fn[constants.NS].defaults, opts); // Merge `settings`, `defaults` and `options`.
				
				//----------------------------------
				// Initialize `data`:
				//----------------------------------
				
				if ( ! data) {
					
					//----------------------------------
					// Create HTML:
					//----------------------------------
					
					var $wrap   = $('<div />', { 'class' : constants.NS }),                                // `<div>` that holds generated elements.
					    $toggle = $('<div />', { 'class' : settings.internal.toggleClass }),               // Toggle button `<div>`.
					    $a      = $('<a />',   { 'class' : settings.internal.closedClass, 'href' : '#' }); // Toggle button `<a>`.
					
					//----------------------------------
					// Namespaced instance `data`:
					//----------------------------------
					
					$this.data(constants.NS, {
						
						a       : $a,
						init    : false,
						options : options,
						target  : $this,
						toggle  : $toggle,
						//toggled : false,
						wrap    : $wrap
						
					});
					
					//----------------------------------
					// Easy access for later:
					//----------------------------------
					
					data = $this.data(constants.NS);
					
				}
				
				//----------------------------------
				// Data initialization check:
				//----------------------------------
				
				if ( ! data.init) {
					
					//----------------------------------
					// Data initialization `flag`:
					//----------------------------------
					
					data.init = true;
					
					//----------------------------------
					// Callback:
					//----------------------------------
					
					data.options.onInit.call(data.target);
					
					//----------------------------------
					// Check for object(s):
					//----------------------------------
					
					if (data.target.length) {
						
						//----------------------------------
						// Get the (cloned) menu?
						//----------------------------------
						
						var $menu = (data.options.clone) ? getClone.call(data.target) : data.target;
						
						//----------------------------------
						// Add `<a>` to toggle `<div>`:
						//----------------------------------
						
						data.a.appendTo(data.toggle);
						
						//----------------------------------
						// Setup toggle:
						//----------------------------------
						
						makeToggle.call(data.target, data.a, $menu);
						
						//----------------------------------
						// Add toggle `<div>` to wrap `<div>`:
						//----------------------------------
						
						data.wrap.append(data.toggle);
						
						//----------------------------------
						// Clone?
						//----------------------------------
						
						if (data.options.clone) {
							
							data.wrap.append($menu);
							
						}
						
						//----------------------------------
						// Clone?
						//----------------------------------
						
						data.wrap.insertBefore(data.target);
						
						//----------------------------------
						// Callback:
						//----------------------------------
						
						data.options.onAfterInit.call(data.target);
						
					} else {
						
						console.warn('there was a problem with your markup');
						
						return this;
						
					}
					
				} else {
					
					console.warn(constants.NS, 'already initialized on', this);
					
					return this;
					
				}
				
			});
			
		}, // init()
		
		//--------------------------------------------------------------------
		
		/**
		 * Removes plugin from element.
		 *
		 * @type   { function }
		 * @this   { object.jquery }
		 * @return { object.jquery } Returns target object(s) for chaining purposes.
		 */
		
		destroy: function() {
			
			//----------------------------------
			// Loop & return each `this`:
			//----------------------------------
			
			return this.each(function() {
				
				//----------------------------------
				// Local variable(s):
				//----------------------------------
				
				var $$   = $(this),
				    data = $$.data(constants.NS);
				
				//----------------------------------
				// Data?
				//----------------------------------
				
				if (data) {
					
					//----------------------------------
					// Clone?
					//----------------------------------
					
					if ( ! data.options.clone) {
						
						//----------------------------------
						// Remove `style` attribute:
						//----------------------------------
						
						data.target.removeAttr('style');
						
					}
					
					//----------------------------------
					// Remove generated `HTML`:
					//----------------------------------
					
					data.wrap.remove(); // All bound events and jQuery data associated with the elements are removed: rgne.ws/LqMnF5
					
					//----------------------------------
					// Remove `data` from `target`:
					//----------------------------------
					
					$$.removeData(constants.NS);
					
				}
			
			});
			
		} // destroy()
		
	}, // methods
	
	//--------------------------------------------------------------------------
	//
	// Private methods:
	//
	//--------------------------------------------------------------------------
	
	/**
	 * Get menu.
	 *
	 * @type   { function }
	 * @this   { object.jquery }
	 * @return { object.jquery } Returns clone of @this.
	 */
	
	getClone = function() {
		
		//----------------------------------
		// Local variable(s):
		//----------------------------------
		
		var data    = this.data(constants.NS),
		    $clone  = this.clone();
		
		//----------------------------------
		// ID?
		//----------------------------------
		
		if (typeof data.options.cloneId === 'string') {
			
			//----------------------------------
			// Use provided ID string:
			//----------------------------------
			
			$clone.attr('id', data.options.cloneId);
			
		} else if (data.options.cloneId) {
			
			//----------------------------------
			// Instead, get ID of `target`:
			//----------------------------------
			
			var id = $clone.attr('id');
			
			//----------------------------------
			// Auto-generate id with prefix:
			//----------------------------------
			
			if (id) {
				
				$clone.attr('id', constants.PREFIX + '-' + id);
				
			}
			
		} else {
			
			//----------------------------------
			// Just remove the cloned ID:
			//----------------------------------
			
			$clone.removeAttr('id');
			
		}
		
		//----------------------------------
		// Remove cloned children elements?
		//----------------------------------
		
		if (data.options.cloneRemove) {
			
			$clone.find(data.options.cloneRemove).remove();
			
		}
		
		$clone
			
			//----------------------------------
			// Add "clone" class:
			//----------------------------------
			
			.addClass(settings.internal.cloneClass)
			
			//----------------------------------
			// Hide:
			//----------------------------------
			
			.hide();
		
		//----------------------------------
		// Return the cloned menu:
		//----------------------------------
		
		return $clone;
		
	}, // getClone()
	
	//--------------------------------------------------------------------
	
	/**
	 * Get menu.
	 *
	 * @type  { function }
	 * @param { object.jquery } $a jQuery `<a>` object.
	 * @param { object.jquery } $menu jQuery `<ul>` object.
	 * @this  { object.jquery }
	 */
	
	makeToggle = function($a, $menu) {
		
		//----------------------------------
		// Local variable(s):
		//----------------------------------
		
		var data = this.data(constants.NS);
		
		//----------------------------------
		// Setup toggle:
		//----------------------------------
		
		$a.on('click.' + constants.NS + ' touchstart.' + constants.NS, function(e) {
			
			//----------------------------------
			// Handle event type:
			//----------------------------------
			
			if ( ! e.handled) { // rgne.ws/Ny7oxk
				
				//----------------------------------
				// Local variable(s)?
				//----------------------------------
				
				var $$      = $(this),
				    toggled = $$.data(constants.NS + '.toggled'); // rgne.ws/PX7b8K
				
				//----------------------------------
				// Toggle state:
				//----------------------------------
				
				$$.data(constants.NS + '.toggled', ( ! toggled));
				
				if ( ! toggled) {
					
					//----------------------------------
					// Callback:
					//----------------------------------
					
					data.options.onBeforeShow.call($menu);
					
					$$
						
						//----------------------------------
						// Remove existing classes:
						//----------------------------------
						
						.removeClass()
						
						//----------------------------------
						// Add "opened" class:
						//----------------------------------
						
						.addClass(settings.internal.openedClass);
					
					//----------------------------------
					// Menu:
					//----------------------------------
					
					$menu
						
						//----------------------------------
						// Stop and clear queue:
						//----------------------------------
						
						.stop(true)
						
						//----------------------------------
						// Animate open:
						//----------------------------------
						
						.animate(data.options.animIn, data.options.speedIn, data.options.easeIn, function() {
							
							//----------------------------------
							// Callback:
							//----------------------------------
							
							data.options.onShow.call($menu);
							
						});
					
				} else {
					
					//----------------------------------
					// Callback:
					//----------------------------------
					
					data.options.onBeforeHide.call($menu);
					
					//----------------------------------
					// Menu:
					//----------------------------------
					
					$menu
						
						//----------------------------------
						// Stop and clear queue:
						//----------------------------------
						
						.stop(true)
						
						//----------------------------------
						// Animate closed:
						//----------------------------------
						
						.animate(data.options.animOut, data.options.speedOut, data.options.easeOut, function() {
							
							//----------------------------------
							// Toggle:
							//----------------------------------
							
							$$
								
								//----------------------------------
								// Remove existing classes:
								//----------------------------------
								
								.removeClass()
								
								//----------------------------------
								// Add "closed" class:
								//----------------------------------
								
								.addClass(settings.internal.closedClass);
							
							//----------------------------------
							// Callback:
							//----------------------------------
							
							data.options.onHide.call($menu);
							
						});
					
				}
				
				//----------------------------------
				// Event has been handled:
				//----------------------------------
				
				e.handled = true;
				
			}
			
			//----------------------------------
			// Stop propagation:
			//----------------------------------
			
			e.stopPropagation();
			
			//----------------------------------
			// Prevent default:
			//----------------------------------
			
			e.preventDefault();
			
		});
		
	}; // makeToggle()
	
	//--------------------------------------------------------------------------
	//
	// Method calling logic:
	//
	//--------------------------------------------------------------------------
	
	/**
	 * Boilerplate plugin logic.
	 *
	 * @link   rgne.ws/OvKpPc
	 * @type   { function }
	 * @param  { string } method String method identifier.
	 * @return { method } Calls plugin method with supplied params.
	 *
	 * @constructor
	 */
	
	$.fn[constants.NS] = function(method) {
		
		//----------------------------------
		// Boilerplate:
		//----------------------------------
		
		if (methods[method]) {
			
			return methods[method].apply(this, Array.prototype.slice.call(arguments, 1));
			
		} else if ((typeof method === 'object') || ( ! method)) {
			
			return methods.init.apply(this, arguments);
			
		} else {
			
			$.error('Method ' + method + ' does not exist on jQuery.' + constants.NS); // Should I override? rgne.ws/MwgkP8
			
		}
		
	}; // constructor()
	
	//--------------------------------------------------------------------------
	//
	// Default settings:
	//
	//--------------------------------------------------------------------------
	
	/**
	 * Settings object.
	 *
	 * @type { object }
	 */
	
	var settings = {}; // Initialize settings object.
	
	//----------------------------------
	
	/**
	 * Private settings.
	 *
	 * @type { object }
	 */
	
	settings.internal = {
		
		cloneClass  : constants.PREFIX + '-clone',
		closedClass : constants.PREFIX + '-closed',
		openedClass : constants.PREFIX + '-opened',
		toggleClass : constants.PREFIX + '-toggle'
		
	}; // settings.internal
	
	//----------------------------------
	
	/**
	 * Public settings.
	 *
	 * @type { object }
	 */
	
	settings.external = {
		
		animIn      : { height: 'toggle' }, // What animation object to use to show the submenus.
		animOut     : { height: 'toggle' }, // IBID, but for hiding.
		clone       : true,                 // Set to false if you don't want to clone target object.
		cloneId     : true,                 // Auto clone id? One of `<id>`, `true` or `false`.
		easeIn      : 'swing',              // Easing function in.
		easeOut     : 'swing',              // Easing function out.
		cloneRemove : false,                // Element(s) for the clone to remove.
		speedIn     : 'normal',             // Animation speed in.
		speedOut    : 'normal',             // Animation speed out.
		
		// Callbacks:
		
		onInit       : $.noop, // After plugin data initialized.
		onAfterInit  : $.noop, // After plugin initialization.
		onBeforeShow : $.noop, // Before reveal animation begins.
		onShow       : $.noop, // After reveal animation ends.
		onBeforeHide : $.noop, // Before hide animation begins.
		onHide       : $.noop  // After hide animation ends.
		
	}; // settings.external
	
	//----------------------------------
	
	/**
	 * Assign defaults to external.
	 *
	 * @type { object }
	 */
	
	$.fn[constants.NS].defaults = settings.external; // rgne.ws/Mxifnq
	
}(jQuery, window, document));